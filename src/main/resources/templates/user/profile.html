<!DOCTYPE html>
<html
  lang="en"
  th:replace="~{base :: parent(~{::#content},~{::title},~{::script})}"
>
  <head>
    <title data-th-text="${loggedInUser.name}+' |  SCM'">Profile Page</title>
  </head>
  <body>
    <div id="content">
      <!-- sidebar -->

      <!-- user is logged in : sidebar -->

      <div th:if="${loggedInUser}">
        <div data-th-replace="~{user/sidebar :: sidebar}"></div>
      </div>

      <div class="sm:pl-64 pt-20 min-h-screen bg-gray-50 dark:bg-gray-900 pb-10">
        <div class="flex items-center justify-center md:pt-10 flex-col px-4">
          <!--  profile card -->
          <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-2xl w-full">
            <form id="profileForm" th:action="@{/user/profile/update}" method="POST" enctype="multipart/form-data">
              <div class="flex flex-col items-center">
                <!-- Profile Photo Upload Section -->
                <div class="relative mb-6 group">
                  <div id="photoPreview" class="w-44 h-44 rounded-full shadow-lg object-cover bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                    <img id="currentPhoto" data-th-src="@{${loggedInUser.profilePic}}" src="" alt="Profile Photo" class="w-full h-full object-cover" th:if="${loggedInUser.profilePic != null}">
                    <i id="defaultIcon" class="fa-solid fa-user text-6xl text-gray-400" th:if="${loggedInUser.profilePic == null}"></i>
                  </div>
                  <label for="profilePhoto" class="absolute bottom-2 right-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 cursor-pointer shadow-lg transition-colors">
                    <i class="fa-solid fa-camera"></i>
                  </label>
                  <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" class="hidden" onchange="previewPhoto(this)">
                </div>
                <p class="text-sm text-gray-500 mb-6">Click camera icon to upload photo</p>

                <!-- Name (Read Only) -->
                <div class="w-full mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                  <input type="text" name="name" data-th-value="${loggedInUser.name}" 
                         class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300" 
                         readonly>
                </div>

                <!-- Email Section with Verification Toggle -->
                <div class="w-full mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                  <div class="flex gap-2">
                    <input type="email" id="email" name="email" data-th-value="${loggedInUser.email}" 
                           class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           onchange="markUnverified('email')">
                  </div>
                  
                  <!-- Email Verification Status & Toggle -->
                  <div class="mt-2 flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center">
                      <span id="emailStatusIcon" class="mr-2" th:class="${loggedInUser.emailVerified} ? 'text-green-500' : 'text-red-500'">
                        <i th:class="${loggedInUser.emailVerified} ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle'"></i>
                      </span>
                      <span id="emailStatusText" class="text-sm" th:text="${loggedInUser.emailVerified} ? 'Email Verified' : 'Email Not Verified'">Email Not Verified</span>
                    </div>
                    <label class="flex items-center cursor-pointer">
                      <div class="relative">
                        <input type="checkbox" id="emailVerified" name="emailVerified" class="sr-only" 
                               th:checked="${loggedInUser.emailVerified}" onchange="toggleVerification('email')">
                        <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner transition-colors toggle-bg" id="emailToggleBg"></div>
                        <div class="dot absolute w-4 h-4 bg-white rounded-full shadow -left-1 -top-1 transition transform toggle-dot" id="emailToggleDot"></div>
                      </div>
                      <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">Verified</span>
                    </label>
                  </div>
                </div>

                <!-- Phone Section with Verification Toggle -->
                <div class="w-full mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number</label>
                  <div class="flex gap-2">
                    <input type="tel" id="phoneNumber" name="phoneNumber" data-th-value="${loggedInUser.phoneNumber}" 
                           class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           onchange="markUnverified('phone')">
                  </div>
                  
                  <!-- Phone Verification Status & Toggle -->
                  <div class="mt-2 flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center">
                      <span id="phoneStatusIcon" class="mr-2" th:class="${loggedInUser.phoneVerified} ? 'text-green-500' : 'text-red-500'">
                        <i th:class="${loggedInUser.phoneVerified} ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle'"></i>
                      </span>
                      <span id="phoneStatusText" class="text-sm" th:text="${loggedInUser.phoneVerified} ? 'Phone Verified' : 'Phone Not Verified'">Phone Not Verified</span>
                    </div>
                    <label class="flex items-center cursor-pointer">
                      <div class="relative">
                        <input type="checkbox" id="phoneVerified" name="phoneVerified" class="sr-only" 
                               th:checked="${loggedInUser.phoneVerified}" onchange="toggleVerification('phone')">
                        <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner transition-colors toggle-bg" id="phoneToggleBg"></div>
                        <div class="dot absolute w-4 h-4 bg-white rounded-full shadow -left-1 -top-1 transition transform toggle-dot" id="phoneToggleDot"></div>
                      </div>
                      <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">Verified</span>
                    </label>
                  </div>
                </div>

                <!-- About -->
                <div class="w-full mb-6">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">About</label>
                  <textarea name="about" rows="3" data-th-text="${loggedInUser.about}"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white resize-none"
                            placeholder="Tell us about yourself..."></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="w-full flex gap-4">
                  <button type="button" onclick="window.location.reload()" 
                          class="flex-1 px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                  </button>
                  <button type="submit" 
                          class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                    <i class="fa-solid fa-save mr-2"></i>Save Changes
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Toggle Switch Styles */
      input:checked ~ .toggle-bg {
        background-color: #10b981;
      }
      input:checked ~ .toggle-dot {
        transform: translateX(100%);
      }
      .toggle-dot {
        top: 0.25rem;
        left: 0.25rem;
      }
    </style>

    <script>
      console.log("Profile page loaded");

      // Initialize toggle states on page load
      document.addEventListener('DOMContentLoaded', function() {
        updateToggleVisuals('email', document.getElementById('emailVerified').checked);
        updateToggleVisuals('phone', document.getElementById('phoneVerified').checked);
      });

      // Preview uploaded photo
      function previewPhoto(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // Mark field as unverified when edited
      function markUnverified(type) {
        const checkbox = document.getElementById(type + 'Verified');
        if (checkbox.checked) {
          checkbox.checked = false;
          updateToggleVisuals(type, false);
          updateStatusText(type, false);
        }
      }

      // Toggle verification status
      function toggleVerification(type) {
        const checkbox = document.getElementById(type + 'Verified');
        const isVerified = checkbox.checked;
        updateToggleVisuals(type, isVerified);
        updateStatusText(type, isVerified);
      }

      // Update toggle visual appearance
      function updateToggleVisuals(type, isVerified) {
        const bg = document.getElementById(type + 'ToggleBg');
        if (isVerified) {
          bg.classList.remove('bg-gray-200');
          bg.classList.add('bg-green-500');
        } else {
          bg.classList.remove('bg-green-500');
          bg.classList.add('bg-gray-200');
        }
      }

      // Update status text and icon
      function updateStatusText(type, isVerified) {
        const iconSpan = document.getElementById(type + 'StatusIcon');
        const textSpan = document.getElementById(type + 'StatusText');
        
        if (isVerified) {
          iconSpan.className = 'mr-2 text-green-500';
          iconSpan.innerHTML = '<i class="fa-solid fa-check-circle"></i>';
          textSpan.textContent = type.charAt(0).toUpperCase() + type.slice(1) + ' Verified';
        } else {
          iconSpan.className = 'mr-2 text-red-500';
          iconSpan.innerHTML = '<i class="fa-solid fa-times-circle"></i>';
          textSpan.textContent = type.charAt(0).toUpperCase() + type.slice(1) + ' Not Verified';
        }
      }
    </script>
  </body>
</html>
